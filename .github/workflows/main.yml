name: Morning Market Analysis

on:
  schedule:
    # Runs at 2:40 AM IST daily (9:10 PM UTC)
    - cron: '10 21 * * *'
    
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'

jobs:
  market-analysis:
    runs-on: ubuntu-latest
    name: Generate Morning Report
    
    steps:
      - name: ğŸ• Display IST Time
        run: |
          echo "========================================"
          echo "â° CURRENT IST: $(TZ='Asia/Kolkata' date '+%H:%M:%S')"
          echo "ğŸ“… DATE: $(TZ='Asia/Kolkata' date '+%d %b %Y')"
          echo "ğŸ¯ SCHEDULED: 2:40 AM IST"
          echo "========================================"
      
      - name: ğŸ“¥ Get Latest Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: ğŸ Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Python Packages
        run: |
          echo "Installing required packages..."
          pip install --upgrade pip
          pip install yfinance==0.2.28
          pip install pandas==2.1.4
          pip install requests==2.31.0
          pip install pytz==2023.3
          pip install numpy==1.26.2
          echo "âœ… All packages installed"
      
      - name: ğŸš€ Execute Market Analysis
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
          ANALYSIS_TIME: "2:40 AM IST"
        run: |
          echo "ğŸš€ Starting Market Analysis..."
          echo "â° Analysis Time: $ANALYSIS_TIME"
          echo "ğŸ“Š Running ultimate_algo.py..."
          python ultimate_algo.py
          
      - name: âœ… Completion Status
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ JOB COMPLETED"
          echo "â° END TIME: $(TZ='Asia/Kolkata' date '+%H:%M:%S IST')"
          echo "ğŸ“… DATE: $(TZ='Asia/Kolkata' date '+%d %b %Y')"
          echo "âœ… Next run: Tomorrow 2:40 AM IST"
          echo "========================================"
